<!-- Generated by pkgdown: do not edit by hand -->
<!DOCTYPE html>
<html lang="en">
  <head>
  <meta charset="utf-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<meta name="viewport" content="width=device-width, initial-scale=1.0">

<title>Comparing Cubist and RuleFit — cubist_and_rulefit • rules</title>

<!-- favicons -->
<link rel="icon" type="image/png" sizes="16x16" href="../favicon-16x16.png">
<link rel="icon" type="image/png" sizes="32x32" href="../favicon-32x32.png">
<link rel="apple-touch-icon" type="image/png" sizes="180x180" href="../apple-touch-icon.png" />
<link rel="apple-touch-icon" type="image/png" sizes="120x120" href="../apple-touch-icon-120x120.png" />
<link rel="apple-touch-icon" type="image/png" sizes="76x76" href="../apple-touch-icon-76x76.png" />
<link rel="apple-touch-icon" type="image/png" sizes="60x60" href="../apple-touch-icon-60x60.png" />

<!-- jquery -->
<script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.4.1/jquery.min.js" integrity="sha256-CSXorXvZcTkaix6Yvo6HppcZGetbYMGWSFlBw8HfCJo=" crossorigin="anonymous"></script>

<!-- Bootstrap -->
<link href="../tidyverse.css" rel="stylesheet">
<script src="https://cdnjs.cloudflare.com/ajax/libs/twitter-bootstrap/3.4.1/js/bootstrap.min.js" integrity="sha256-nuL8/2cJ5NDSSwnKD8VqreErSWHtnEP9E7AySL+1ev4=" crossorigin="anonymous"></script>

<!-- bootstrap-toc -->
<link rel="stylesheet" href="../bootstrap-toc.css">
<script src="../bootstrap-toc.js"></script>

<!-- Font Awesome icons -->
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.12.1/css/all.min.css" integrity="sha256-mmgLkCYLUQbXn0B1SRqzHar6dCnv9oZFPEC1g1cwlkk=" crossorigin="anonymous" />
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.12.1/css/v4-shims.min.css" integrity="sha256-wZjR52fzng1pJHwx4aV2AO3yyTOXrcDW7jBpJtTwVxw=" crossorigin="anonymous" />

<!-- clipboard.js -->
<script src="https://cdnjs.cloudflare.com/ajax/libs/clipboard.js/2.0.4/clipboard.min.js" integrity="sha256-FiZwavyI2V6+EXO1U+xzLG3IKldpiTFf3153ea9zikQ=" crossorigin="anonymous"></script>

<!-- headroom.js -->
<script src="https://cdnjs.cloudflare.com/ajax/libs/headroom/0.11.0/headroom.min.js" integrity="sha256-AsUX4SJE1+yuDu5+mAVzJbuYNPHj/WroHuZ8Ir/CkE0=" crossorigin="anonymous"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/headroom/0.11.0/jQuery.headroom.min.js" integrity="sha256-ZX/yNShbjqsohH1k95liqY9Gd8uOiE1S4vZc+9KQ1K4=" crossorigin="anonymous"></script>

<!-- pkgdown -->
<link href="../pkgdown.css" rel="stylesheet">
<script src="../pkgdown.js"></script>
<link href="../tidyverse-2.css" rel="stylesheet">

<!--optional theme-->
<link href="../tidymodels.css" rel="stylesheet">




<meta property="og:title" content="Comparing Cubist and RuleFit — cubist_and_rulefit" />
<meta property="og:description" content="Comparing Cubist and RuleFit" />
<meta property="og:image" content="https://rules.tidymodels.org/logo.png" />
<meta name="twitter:card" content="summary" />


<meta name="robots" content="noindex">

<!-- mathjax -->
<script src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.5/MathJax.js" integrity="sha256-nvJJv9wWKEm88qvoQl9ekL2J+k/RWIsaSScxxlsrv8k=" crossorigin="anonymous"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.5/config/TeX-AMS-MML_HTMLorMML.js" integrity="sha256-84DKXVJXs0/F8OTMzX4UR909+jtl4G7SPypPavF+GfA=" crossorigin="anonymous"></script>

<!--[if lt IE 9]>
<script src="https://oss.maxcdn.com/html5shiv/3.7.3/html5shiv.min.js"></script>
<script src="https://oss.maxcdn.com/respond/1.4.2/respond.min.js"></script>
<![endif]-->

<!-- Global site tag (gtag.js) - Google Analytics -->
<script async src="https://www.googletagmanager.com/gtag/js?id=UA-115082821-1"></script>
<script>
  window.dataLayer = window.dataLayer || [];
  function gtag(){dataLayer.push(arguments);}
  gtag('js', new Date());

  gtag('config', 'UA-115082821-1');
</script>

  

  

  </head>

  <body data-spy="scroll" data-target="#toc">
    

    <div class="container template-reference-topic">
      <header>
      <div class="navbar navbar-default navbar-fixed-top" role="navigation">
  <div class="container">
    <div class="navbar-header">
      <button type="button" class="navbar-toggle collapsed" data-toggle="collapse" data-target="#navbar" aria-expanded="false">
        <span class="sr-only">Toggle navigation</span>
        <span class="icon-bar"></span>
        <span class="icon-bar"></span>
        <span class="icon-bar"></span>
      </button>

      <div class="navbar-brand-container">
        <a class="navbar-brand" href="../index.html">rules</a>
        <div class="info hidden-xs hidden-sm">
          <span class="partof">part of <a href="https://tidymodels.orgs">tidymodels</a></span>
          <span class="version version-danger" data-toggle="tooltip" data-placement="bottom" title="In-development version">0.1.2.9000</span>
        </div>
      </div>
    </div>
    <div id="navbar" class="navbar-collapse collapse">
      <ul class="nav navbar-nav navbar-right">
        <li>
  <a href="../articles/Cubist-and-RuleFit.html">What's the difference between Cubist and RuleFit?</a>
</li>
<li>
  <a href="../news/index.html">News</a>
</li>
<li>
  <a href="../reference/index.html">Reference</a>
</li>
        <li>
  <a href="https://github.com/tidymodels/rules/">
    <span class="fab fa-github fa-lg"></span>
     
  </a>
</li>
      </ul>
      
    </div><!--/.nav-collapse -->
  </div><!--/.container -->
</div><!--/.navbar -->

      

      </header>

<div class="row">
  <div class="col-md-9 contents">
    <div class="page-header">
    <h1>Comparing Cubist and RuleFit</h1>
    <small class="dont-index">Source: <a href='https://github.com/tidymodels/rules/blob/master/R/cubist_and_rulefit.R'><code>R/cubist_and_rulefit.R</code></a></small>
    <div class="hidden name"><code>cubist_and_rulefit.Rd</code></div>
    </div>

    <div class="ref-description">
    <p>Comparing Cubist and RuleFit</p>
    </div>



    <h2 class="hasAnchor" id="what-s-the-difference-between-cubist-and-rulefit-"><a class="anchor" href="#what-s-the-difference-between-cubist-and-rulefit-"></a>What’s the difference between Cubist and RuleFit?</h2>

    <p><a href='https://www.rulequest.com/cubist-win.html'>Cubist</a> and
<a href='https://statweb.stanford.edu/~jhf/R_RuleFit.html'>RuleFit</a> are two
rule-based regression models. They are similar in some ways but
otherwise very different. This is a short description of their
approaches.</p>
<p>Cubist is for numeric outcomes while RuleFit can work with numeric and
categorical outcomes. For this document, we’ll focus on numeric outcomes
(without loss of generality).</p><h3 class='hasAnchor' id='both-start-by-making-rules-from-trees'><a class='anchor' aria-hidden='true' href='#both-start-by-making-rules-from-trees'></a>Both start by making rules from trees</h3>


<p>For each model, an an initial tree-based model is created. Let’s look at
a really simple example tree:<div class="r"></p><pre><code>if (A &lt; a) {
  if (B &lt; b) {
    node &lt;- 1
  } else {
    node &lt;- 2
  }
} else
  node &lt;- 3
}
</code></pre><p></div></p>
<p>In this case, two predictors are used in splits: <code>A</code> and <code>B</code>. With this
model, the split to the left is the “&lt;” condition. There are three
terminal nodes. This tree-based structure can be converted to a set of
distinct rules. Each rule is a collection of <code>if/then</code> statements that
define the path to the terminal nodes. In this example:<div class="r"></p><pre class='sourceCode r'><code><span class='va'>rule_1</span> <span class='op'>&lt;-</span> <span class='op'>(</span><span class='va'>A</span> <span class='op'>&lt;</span>  <span class='va'>a</span><span class='op'>)</span> <span class='op'>&amp;</span> <span class='op'>(</span><span class='va'>B</span> <span class='op'>&lt;</span>  <span class='va'>b</span><span class='op'>)</span>
<span class='va'>rule_2</span> <span class='op'>&lt;-</span> <span class='op'>(</span><span class='va'>A</span> <span class='op'>&lt;</span>  <span class='va'>a</span><span class='op'>)</span> <span class='op'>&amp;</span> <span class='op'>(</span><span class='va'>B</span> <span class='op'>&gt;=</span> <span class='va'>b</span><span class='op'>)</span>
<span class='va'>rule_3</span> <span class='op'>&lt;-</span> <span class='op'>(</span><span class='va'>A</span> <span class='op'>&gt;=</span> <span class='va'>a</span><span class='op'>)</span>
</code></pre><p></div></p>
<p>As is, these paths through the tree are mutually exclusive. For deep
trees, these rules can become overly complex and may contain
redundancies. Cubist takes the approach of simplifying rules whenever
possible (Quinlan (1987)). For example,<div class="r"></p><pre class='sourceCode r'><code><span class='va'>rule_x</span> <span class='op'>&lt;-</span> <span class='op'>(</span><span class='va'>A</span> <span class='op'>&lt;</span>  <span class='fl'>10</span><span class='op'>)</span>  <span class='op'>&amp;</span> <span class='op'>(</span><span class='va'>A</span> <span class='op'>&lt;</span>  <span class='fl'>7</span><span class='op'>)</span> <span class='op'>&amp;</span> <span class='op'>(</span><span class='va'>B</span> <span class='op'>&gt;=</span> <span class='fl'>1</span><span class='op'>)</span>
</code></pre><p></div></p>
<p>becomes<div class="r"></p><pre class='sourceCode r'><code><span class='va'>rule_y</span> <span class='op'>&lt;-</span> <span class='op'>(</span><span class='va'>A</span> <span class='op'>&lt;</span> <span class='fl'>7</span><span class='op'>)</span> <span class='op'>&amp;</span> <span class='op'>(</span><span class='va'>B</span> <span class='op'>&gt;=</span> <span class='fl'>1</span><span class='op'>)</span>
</code></pre><p></div></p>
<p>Cubist also has an approach that can <em>prune</em> conditions inside of the
rule that simplifies the structure without degrading performance. If <code>B</code>
doesn’t matter much in the rule above, then Cubist could reduce it to
<code>A &lt; 7</code>.</p>
<p>Cubist and RuleFit are also ensemble methods. For RuleFit, any tree
ensemble model could generate a set of rules. For the <code>xrf</code> package, the
<code>xgboost</code> package creates the initial set of rules. The rules create be
each tree are pooled into a broader rule set. Cubist takes a different
approach and uses model committees (see
<a href='http://appliedpredictivemodeling.com/'><em>APM</em></a> Chapter 14). This is
similar to boosting but creates a pseudo-outcome for each tree in the
ensemble. This outcome adjusts the trees based on the size of the
residual from the previous tree.</p>
<p>At the end of the rule generating process, the rules are unlikely to
mutually exclusive. Any data point is likely to be fall into multiple
rules.</p>
<p>Now let’s look at how each model uses the rules.</p>

<h3 class='hasAnchor' id='cubists-makes-a-model-for-each-rule'><a class='anchor' aria-hidden='true' href='#cubists-makes-a-model-for-each-rule'></a>Cubists makes a model for each rule</h3>


<p>Before delving into the rules, let’s start with the <em>model tree</em>
initially created by Cubist (Quinlan (1992)). An initial tree is created
and a regression model is created for <em>each split in the tree</em>. Each
linear regression is created on the subset of the data covered by the
current rule and uses only the predictors in the current rule. In the
tree shown above, the first split produces two models with <code>A</code> as a
predictor. The data for each are filtered either with <code>A &lt; a</code> or
<code>A &gt;= a</code>. The entire set of models are:<div class="r"></p><pre class='sourceCode r'><code><span class='va'>split_1_low</span>  <span class='op'>&lt;-</span> <span class='fu'><a href='https://rdrr.io/r/stats/filter.html'>filter</a></span><span class='op'>(</span><span class='va'>data</span>, <span class='va'>A</span> <span class='op'>&lt;</span>  <span class='va'>a</span><span class='op'>)</span>
<span class='va'>model_1_low</span>  <span class='op'>&lt;-</span> <span class='fu'><a href='https://rdrr.io/r/stats/lm.html'>lm</a></span><span class='op'>(</span><span class='va'>y</span> <span class='op'>~</span> <span class='va'>A</span>, data <span class='op'>=</span> <span class='va'>split_1_low</span><span class='op'>)</span>

<span class='va'>split_1_high</span> <span class='op'>&lt;-</span> <span class='fu'><a href='https://rdrr.io/r/stats/filter.html'>filter</a></span><span class='op'>(</span><span class='va'>data</span>, <span class='va'>A</span> <span class='op'>&gt;=</span> <span class='va'>a</span><span class='op'>)</span>
<span class='va'>model_1_high</span> <span class='op'>&lt;-</span> <span class='fu'><a href='https://rdrr.io/r/stats/lm.html'>lm</a></span><span class='op'>(</span><span class='va'>y</span> <span class='op'>~</span> <span class='va'>A</span>, data <span class='op'>=</span> <span class='va'>split_1_high</span><span class='op'>)</span>

<span class='va'>split_2_low</span>  <span class='op'>&lt;-</span> <span class='fu'><a href='https://rdrr.io/r/stats/filter.html'>filter</a></span><span class='op'>(</span><span class='va'>data</span>, <span class='va'>A</span> <span class='op'>&lt;</span>  <span class='va'>a</span> <span class='op'>&amp;</span> <span class='va'>B</span> <span class='op'>&lt;</span>  <span class='va'>b</span><span class='op'>)</span>
<span class='va'>model_2_low</span>  <span class='op'>&lt;-</span> <span class='fu'><a href='https://rdrr.io/r/stats/lm.html'>lm</a></span><span class='op'>(</span><span class='va'>y</span> <span class='op'>~</span> <span class='va'>A</span> <span class='op'>+</span> <span class='va'>B</span>, data <span class='op'>=</span> <span class='va'>split_2_low</span><span class='op'>)</span>

<span class='va'>split_2_high</span> <span class='op'>&lt;-</span> <span class='fu'><a href='https://rdrr.io/r/stats/filter.html'>filter</a></span><span class='op'>(</span><span class='va'>data</span>, <span class='va'>A</span> <span class='op'>&lt;</span>  <span class='va'>a</span> <span class='op'>&amp;</span> <span class='va'>B</span> <span class='op'>&gt;=</span> <span class='va'>b</span><span class='op'>)</span>
<span class='va'>model_2_high</span> <span class='op'>&lt;-</span> <span class='fu'><a href='https://rdrr.io/r/stats/lm.html'>lm</a></span><span class='op'>(</span><span class='va'>y</span> <span class='op'>~</span> <span class='va'>A</span> <span class='op'>+</span> <span class='va'>B</span>, data <span class='op'>=</span> <span class='va'>split_2_high</span><span class='op'>)</span>
</code></pre><p></div></p>
<p>Cubist does some feature selection on these models so they may not
contain all of the possible predictors. Also, since Cubist prunes the
rules, there may be not appear to be a connection between the variables
used in a rule and its corresponding model.</p>
<p>The models associated with the rules are actually average of many models
further up the tree. Since these are linear models, the models used by
Cubist for each rule have coefficients that are averages:</p><table class='table'>
<tr><td>Rule</td><td>Logic</td><td>Blended Models</td></tr>
<tr><td>1</td><td><code>A &lt;  a &amp; B &lt; b</code></td><td><code>model_1_low</code> and <code>model_2_low</code></td></tr>
<tr><td>2</td><td><code>A &lt;  a &amp; B &gt;= b</code></td><td><code>model_1_low</code> and <code>model_2_high</code></td></tr>
<tr><td>2</td><td><code>A &gt;= a</code></td><td><code>model_1_high</code></td></tr>
</table>



<p>The equations for averaging were first described in Quinlan (1992) but
the updated equation for Cubist can be found in Chapter 14 of
<a href='http://appliedpredictivemodeling.com/'><em>APM</em></a>.</p>
<p>There is a model for each committee and rule within committee. When
predicting, a new observation is compared to the conditions in the rules
to determine which rules are active for this data point. The active
linear models predict the new sample and these predictions are averaged
to produce the final prediction value.</p>
<p>Perhaps unrelated to this document, which focuses on how rules are used,
Cubist also does a nearest-neighbor correction to the predicted values
(Quinlan R (1993)).</p>
<p>Let’s look at an example model on the Palmer penguin data:<div class="r"></p><pre class='sourceCode r'><code><span class='kw'><a href='https://rdrr.io/r/base/library.html'>library</a></span><span class='op'>(</span><span class='va'><a href='https://github.com/tidymodels/rules'>rules</a></span><span class='op'>)</span>
<span class='fu'><a href='https://rdrr.io/r/utils/data.html'>data</a></span><span class='op'>(</span><span class='va'>penguins</span>, package <span class='op'>=</span> <span class='st'>"modeldata"</span><span class='op'>)</span>

<span class='va'>cubist_fit</span> <span class='op'>&lt;-</span> 
  <span class='fu'><a href='cubist_rules.html'>cubist_rules</a></span><span class='op'>(</span>committees <span class='op'>=</span> <span class='fl'>2</span><span class='op'>)</span> <span class='op'><a href='https://magrittr.tidyverse.org/reference/pipe.html'>%&gt;%</a></span> 
  <span class='fu'><a href='https://parsnip.tidymodels.org/reference/set_engine.html'>set_engine</a></span><span class='op'>(</span><span class='st'>"Cubist"</span><span class='op'>)</span> <span class='op'><a href='https://magrittr.tidyverse.org/reference/pipe.html'>%&gt;%</a></span> 
  <span class='fu'><a href='https://generics.r-lib.org/reference/fit.html'>fit</a></span><span class='op'>(</span><span class='va'>body_mass_g</span> <span class='op'>~</span> <span class='va'>.</span>, data <span class='op'>=</span> <span class='va'>penguins</span><span class='op'>)</span>
<span class='va'>cubist_fit</span>
<span class='co'>#&gt; parsnip model object</span>
<span class='co'>#&gt; </span>
<span class='co'>#&gt; Fit time:  35ms </span>
<span class='co'>#&gt; </span>
<span class='co'>#&gt; Call:</span>
<span class='co'>#&gt; cubist.default(x = x, y = y, committees = 2)</span>
<span class='co'>#&gt; </span>
<span class='co'>#&gt; Number of samples: 333 </span>
<span class='co'>#&gt; Number of predictors: 6 </span>
<span class='co'>#&gt; </span>
<span class='co'>#&gt; Number of committees: 2 </span>
<span class='co'>#&gt; Number of rules per committee: 5, 1</span>
</code></pre><p></div></p>
<p>The <code><a href='https://rdrr.io/r/base/summary.html'>summary()</a></code> function shows the details of the rules.<div class="r"></p><pre class='sourceCode r'><code><span class='fu'><a href='https://rdrr.io/r/base/summary.html'>summary</a></span><span class='op'>(</span><span class='va'>cubist_fit</span><span class='op'>$</span><span class='va'>fit</span><span class='op'>)</span>
<span class='co'>#&gt; </span>
<span class='co'>#&gt; Call:</span>
<span class='co'>#&gt; cubist.default(x = x, y = y, committees = 2)</span>
<span class='co'>#&gt; </span>
<span class='co'>#&gt; </span>
<span class='co'>#&gt; Cubist [Release 2.07 GPL Edition]  Fri Aug  6 17:48:52 2021</span>
<span class='co'>#&gt; ---------------------------------</span>
<span class='co'>#&gt; </span>
<span class='co'>#&gt;     Target attribute `outcome'</span>
<span class='co'>#&gt; </span>
<span class='co'>#&gt; Read 333 cases (7 attributes) from undefined.data</span>
<span class='co'>#&gt; </span>
<span class='co'>#&gt; Model 1:</span>
<span class='co'>#&gt; </span>
<span class='co'>#&gt;   Rule 1/1: [107 cases, mean 3419.2, range 2700 to 4150, est err 208.3]</span>
<span class='co'>#&gt; </span>
<span class='co'>#&gt;     if</span>
<span class='co'>#&gt;  flipper_length_mm &lt;= 202</span>
<span class='co'>#&gt;  sex = female</span>
<span class='co'>#&gt;     then</span>
<span class='co'>#&gt;  outcome = -1068 + 108 bill_depth_mm + 10.7 flipper_length_mm</span>
<span class='co'>#&gt;            + 14 bill_length_mm</span>
<span class='co'>#&gt; </span>
<span class='co'>#&gt;   Rule 1/2: [92 cases, mean 3972.0, range 3250 to 4775, est err 275.6]</span>
<span class='co'>#&gt; </span>
<span class='co'>#&gt;     if</span>
<span class='co'>#&gt;  flipper_length_mm &lt;= 202</span>
<span class='co'>#&gt;  sex = male</span>
<span class='co'>#&gt;     then</span>
<span class='co'>#&gt;  outcome = 319.1 + 22.3 flipper_length_mm - 21 bill_length_mm</span>
<span class='co'>#&gt;            + 12 bill_depth_mm</span>
<span class='co'>#&gt; </span>
<span class='co'>#&gt;   Rule 1/3: [58 cases, mean 4679.7, range 3950 to 5200, est err 206.6]</span>
<span class='co'>#&gt; </span>
<span class='co'>#&gt;     if</span>
<span class='co'>#&gt;  flipper_length_mm &gt; 202</span>
<span class='co'>#&gt;  sex = female</span>
<span class='co'>#&gt;     then</span>
<span class='co'>#&gt;  outcome = -3923.3 + 30.4 flipper_length_mm + 136 bill_depth_mm</span>
<span class='co'>#&gt;            + 5 bill_length_mm</span>
<span class='co'>#&gt; </span>
<span class='co'>#&gt;   Rule 1/4: [23 cases, mean 4698.9, range 3950 to 6050, est err 275.8]</span>
<span class='co'>#&gt; </span>
<span class='co'>#&gt;     if</span>
<span class='co'>#&gt;  bill_depth_mm &gt; 16.4</span>
<span class='co'>#&gt;  flipper_length_mm &gt; 202</span>
<span class='co'>#&gt;     then</span>
<span class='co'>#&gt;  outcome = -7845.8 + 58.6 flipper_length_mm</span>
<span class='co'>#&gt; </span>
<span class='co'>#&gt;   Rule 1/5: [53 cases, mean 5475.0, range 4750 to 6300, est err 239.3]</span>
<span class='co'>#&gt; </span>
<span class='co'>#&gt;     if</span>
<span class='co'>#&gt;  bill_depth_mm &lt;= 16.4</span>
<span class='co'>#&gt;  sex = male</span>
<span class='co'>#&gt;     then</span>
<span class='co'>#&gt;  outcome = -138.7 + 46 bill_length_mm + 89 bill_depth_mm</span>
<span class='co'>#&gt;            + 8.9 flipper_length_mm</span>
<span class='co'>#&gt; </span>
<span class='co'>#&gt; Model 2:</span>
<span class='co'>#&gt; </span>
<span class='co'>#&gt;   Rule 2/1: [333 cases, mean 4207.1, range 2700 to 6300, est err 315.4]</span>
<span class='co'>#&gt; </span>
<span class='co'>#&gt;  outcome = -5815.1 + 49.7 flipper_length_mm</span>
<span class='co'>#&gt; </span>
<span class='co'>#&gt; </span>
<span class='co'>#&gt; Evaluation on training data (333 cases):</span>
<span class='co'>#&gt; </span>
<span class='co'>#&gt;     Average  |error|              278.7</span>
<span class='co'>#&gt;     Relative |error|               0.41</span>
<span class='co'>#&gt;     Correlation coefficient        0.90</span>
<span class='co'>#&gt; </span>
<span class='co'>#&gt; </span>
<span class='co'>#&gt;  Attribute usage:</span>
<span class='co'>#&gt;    Conds  Model</span>
<span class='co'>#&gt; </span>
<span class='co'>#&gt;     47%           sex</span>
<span class='co'>#&gt;     42%   100%    flipper_length_mm</span>
<span class='co'>#&gt;     11%    47%    bill_depth_mm</span>
<span class='co'>#&gt;            47%    bill_length_mm</span>
<span class='co'>#&gt; </span>
<span class='co'>#&gt; </span>
<span class='co'>#&gt; Time: 0.0 secs</span>
</code></pre><p></div></p>
<p>Note that the only rule in the second committee has no conditions; all
data points being predicted are affected by that rule. Also, it is
possible for the linear model within a rule to only contain an
intercept.</p>
<p>The <code><a href='https://generics.r-lib.org/reference/tidy.html'>tidy()</a></code> function can extract the rule and model data:<div class="r"></p><pre class='sourceCode r'><code><span class='va'>cb_res</span> <span class='op'>&lt;-</span> <span class='fu'><a href='https://generics.r-lib.org/reference/tidy.html'>tidy</a></span><span class='op'>(</span><span class='va'>cubist_fit</span><span class='op'>)</span>
<span class='va'>cb_res</span>
<span class='co'>#&gt; # A tibble: 6 × 5</span>
<span class='co'>#&gt;   committee rule_num rule                             estimate      statistic   </span>
<span class='co'>#&gt;       &lt;int&gt;    &lt;int&gt; &lt;chr&gt;                            &lt;list&gt;        &lt;list&gt;      </span>
<span class='co'>#&gt; 1         1        1 ( sex == 'female' ) &amp; ( flipper… &lt;tibble [4 ×… &lt;tibble [1 …</span>
<span class='co'>#&gt; 2         1        2 ( sex == 'male' ) &amp; ( flipper_l… &lt;tibble [4 ×… &lt;tibble [1 …</span>
<span class='co'>#&gt; 3         1        3 ( flipper_length_mm &gt; 202 ) &amp; (… &lt;tibble [4 ×… &lt;tibble [1 …</span>
<span class='co'>#&gt; 4         1        4 ( flipper_length_mm &gt; 202 ) &amp; (… &lt;tibble [2 ×… &lt;tibble [1 …</span>
<span class='co'>#&gt; 5         1        5 ( bill_depth_mm &lt;= 16.4 ) &amp; ( s… &lt;tibble [4 ×… &lt;tibble [1 …</span>
<span class='co'>#&gt; 6         2        1 &lt;no conditions&gt;                  &lt;tibble [2 ×… &lt;tibble [1 …</span>
</code></pre><p></div></p>
<p>The <code>estimate</code> and <code>statistic</code> columns contain tibbles with parameter
estimates and rule statistics, respectively. They can be easily expanded
using <code>unnest()</code>:<div class="r"></p><pre class='sourceCode r'><code><span class='kw'><a href='https://rdrr.io/r/base/library.html'>library</a></span><span class='op'>(</span><span class='va'><a href='https://tidyr.tidyverse.org'>tidyr</a></span><span class='op'>)</span>
<span class='va'>cb_res</span> <span class='op'><a href='https://tidyr.tidyverse.org/reference/pipe.html'>%&gt;%</a></span> 
  <span class='fu'>dplyr</span><span class='fu'>::</span><span class='fu'><a href='https://dplyr.tidyverse.org/reference/select.html'>select</a></span><span class='op'>(</span><span class='va'>committee</span>, <span class='va'>rule_num</span>, <span class='va'>statistic</span><span class='op'>)</span> <span class='op'><a href='https://tidyr.tidyverse.org/reference/pipe.html'>%&gt;%</a></span> 
  <span class='fu'><a href='https://tidyr.tidyverse.org/reference/nest.html'>unnest</a></span><span class='op'>(</span>cols <span class='op'>=</span> <span class='fu'><a href='https://rdrr.io/r/base/c.html'>c</a></span><span class='op'>(</span><span class='va'>statistic</span><span class='op'>)</span><span class='op'>)</span>
<span class='co'>#&gt; # A tibble: 6 × 8</span>
<span class='co'>#&gt;   committee rule_num num_conditions coverage  mean   min   max error</span>
<span class='co'>#&gt;       &lt;int&gt;    &lt;int&gt;          &lt;dbl&gt;    &lt;dbl&gt; &lt;dbl&gt; &lt;dbl&gt; &lt;dbl&gt; &lt;dbl&gt;</span>
<span class='co'>#&gt; 1         1        1              2      107 3419.  2700  4150  208.</span>
<span class='co'>#&gt; 2         1        2              2       92 3972   3250  4775  276.</span>
<span class='co'>#&gt; 3         1        3              2       58 4680.  3950  5200  207.</span>
<span class='co'>#&gt; 4         1        4              2       23 4699.  3950  6050  276.</span>
<span class='co'>#&gt; 5         1        5              2       53 5475   4750  6300  239.</span>
<span class='co'>#&gt; 6         2        1              0      333 4207.  2700  6300  315.</span>
</code></pre><p></div></p>
<p>For the first committee, rule four contains two conditions and covers 23
data points from the original data set. We can find these data points by
converting the character string for the rule to an R expression, then
evaluate the expression on the data set:<div class="r"></p><pre class='sourceCode r'><code><span class='kw'><a href='https://rdrr.io/r/base/library.html'>library</a></span><span class='op'>(</span><span class='va'><a href='https://dplyr.tidyverse.org'>dplyr</a></span><span class='op'>)</span>
<span class='kw'><a href='https://rdrr.io/r/base/library.html'>library</a></span><span class='op'>(</span><span class='va'><a href='http://purrr.tidyverse.org'>purrr</a></span><span class='op'>)</span>
<span class='kw'><a href='https://rdrr.io/r/base/library.html'>library</a></span><span class='op'>(</span><span class='va'><a href='https://rlang.r-lib.org'>rlang</a></span><span class='op'>)</span>

<span class='va'>rule_4_filter</span> <span class='op'>&lt;-</span> 
  <span class='va'>cb_res</span> <span class='op'><a href='https://magrittr.tidyverse.org/reference/pipe.html'>%&gt;%</a></span> 
  <span class='fu'>dplyr</span><span class='fu'>::</span><span class='fu'><a href='https://dplyr.tidyverse.org/reference/filter.html'>filter</a></span><span class='op'>(</span><span class='va'>rule_num</span> <span class='op'>==</span> <span class='fl'>4</span><span class='op'>)</span> <span class='op'><a href='https://magrittr.tidyverse.org/reference/pipe.html'>%&gt;%</a></span> 
  <span class='fu'><a href='https://purrr.tidyverse.org/reference/pluck.html'>pluck</a></span><span class='op'>(</span><span class='st'>"rule"</span><span class='op'>)</span> <span class='op'><a href='https://magrittr.tidyverse.org/reference/pipe.html'>%&gt;%</a></span>   <span class='co'># &lt;- character string</span>
  <span class='fu'><a href='https://rlang.r-lib.org/reference/parse_expr.html'>parse_expr</a></span><span class='op'>(</span><span class='op'>)</span> <span class='op'><a href='https://magrittr.tidyverse.org/reference/pipe.html'>%&gt;%</a></span>    <span class='co'># &lt;- R expression</span>
  <span class='fu'><a href='https://rlang.r-lib.org/reference/eval_tidy.html'>eval_tidy</a></span><span class='op'>(</span><span class='va'>penguins</span><span class='op'>)</span> <span class='co'># &lt;- logical vector</span>

<span class='va'>penguins</span> <span class='op'><a href='https://magrittr.tidyverse.org/reference/pipe.html'>%&gt;%</a></span> 
  <span class='fu'>dplyr</span><span class='fu'>::</span><span class='fu'><a href='https://dplyr.tidyverse.org/reference/slice.html'>slice</a></span><span class='op'>(</span><span class='fu'><a href='https://rdrr.io/r/base/which.html'>which</a></span><span class='op'>(</span><span class='va'>rule_4_filter</span><span class='op'>)</span><span class='op'>)</span>
<span class='co'>#&gt; # A tibble: 23 × 7</span>
<span class='co'>#&gt;    species island    bill_length_mm bill_depth_mm flipper_length_mm body_mass_g</span>
<span class='co'>#&gt;    &lt;fct&gt;   &lt;fct&gt;              &lt;dbl&gt;         &lt;dbl&gt;             &lt;int&gt;       &lt;int&gt;</span>
<span class='co'>#&gt;  1 Adelie  Dream               41.1          18.1               205        4300</span>
<span class='co'>#&gt;  2 Adelie  Dream               40.8          18.9               208        4300</span>
<span class='co'>#&gt;  3 Adelie  Biscoe              41            20                 203        4725</span>
<span class='co'>#&gt;  4 Adelie  Torgersen           44.1          18                 210        4000</span>
<span class='co'>#&gt;  5 Gentoo  Biscoe              59.6          17                 230        6050</span>
<span class='co'>#&gt;  6 Gentoo  Biscoe              44.4          17.3               219        5250</span>
<span class='co'>#&gt;  7 Gentoo  Biscoe              49.8          16.8               230        5700</span>
<span class='co'>#&gt;  8 Gentoo  Biscoe              50.8          17.3               228        5600</span>
<span class='co'>#&gt;  9 Gentoo  Biscoe              52.1          17                 230        5550</span>
<span class='co'>#&gt; 10 Gentoo  Biscoe              52.2          17.1               228        5400</span>
<span class='co'>#&gt; # … with 13 more rows, and 1 more variable: sex &lt;fct&gt;</span>
</code></pre><p></div></p>

<h3 class='hasAnchor' id='rulefit-makes-one-model-with-rule-predictors'><a class='anchor' aria-hidden='true' href='#rulefit-makes-one-model-with-rule-predictors'></a>RuleFit makes one model with rule predictors</h3>


<p>RuleFit uses rules in a more straightforward way. It creates an initial
tree (or ensemble of trees) from the data. Rules are extracted from this
initial model and converted to a set of binary features. These features
are then added to a regularized regression model (along with the
original columns). For example:<div class="r"></p><pre><code>data_with_rules &lt;- 
  data %&gt;% 
  mutate(
    rule_1 = ifelse(A &lt;  a &amp; B &lt;  b, 0, 1),
    rule_2 = ifelse(A &lt;  a &amp; B &gt;= b, 0, 1),
    rule_2 = ifelse(A &gt;= a,          0, 1)
  )

rule_fit_model &lt;- 
  glmnet(x = data_with_rules %&gt;% select(A, B, starts_with("rule_") %&gt;% as.matrix(),
         y = data_with_rules$y,
         alpha = 1)
</code></pre><p></div></p>
<p>It is common to use a lasso model to regularize the model and eliminate
non-informative features.</p>
<p>While the details can depend on the implementation, the rules do not
appear to be pruned or simplified.</p>
<p>The tuning parameters for this model inherits the parameter of the
tree-based model as well as the amount of regularization used in the
<code>glmnet</code> model. The complexity of the rules is determined by the allowed
depth of the tree. For example, using a depth of four means that each
rule may have up to four terms that define it. The number of rules would
be primarily determined by the number of boosting iterations.</p>
<p>RuleFit, as implemented by the <code>xrf</code> package, required all of the data
to be complete (i.e, non-missing). In the original data set, the body
mass is encoded as integer and <code>xrf</code> requires a double, so:<div class="r"></p><pre class='sourceCode r'><code><span class='va'>penguins</span> <span class='op'>&lt;-</span> 
  <span class='va'>penguins</span> <span class='op'><a href='https://magrittr.tidyverse.org/reference/pipe.html'>%&gt;%</a></span> 
  <span class='fu'><a href='https://dplyr.tidyverse.org/reference/mutate.html'>mutate</a></span><span class='op'>(</span>body_mass_g <span class='op'>=</span> <span class='va'>body_mass_g</span> <span class='op'>+</span> <span class='fl'>0.0</span><span class='op'>)</span> <span class='op'><a href='https://magrittr.tidyverse.org/reference/pipe.html'>%&gt;%</a></span> 
  <span class='fu'><a href='https://rdrr.io/r/stats/na.fail.html'>na.omit</a></span><span class='op'>(</span><span class='op'>)</span>
</code></pre><p></div></p>
<p>Fitting the model:<div class="r"></p><pre class='sourceCode r'><code><span class='va'>rule_fit_spec</span> <span class='op'>&lt;-</span> 
  <span class='fu'><a href='rule_fit.html'>rule_fit</a></span><span class='op'>(</span>trees <span class='op'>=</span> <span class='fl'>10</span>, tree_depth <span class='op'>=</span> <span class='fl'>5</span>, penalty <span class='op'>=</span> <span class='fl'>0.01</span><span class='op'>)</span> <span class='op'><a href='https://magrittr.tidyverse.org/reference/pipe.html'>%&gt;%</a></span> 
  <span class='fu'><a href='https://parsnip.tidymodels.org/reference/set_engine.html'>set_engine</a></span><span class='op'>(</span><span class='st'>"xrf"</span><span class='op'>)</span> <span class='op'><a href='https://magrittr.tidyverse.org/reference/pipe.html'>%&gt;%</a></span>
  <span class='fu'><a href='https://parsnip.tidymodels.org/reference/set_args.html'>set_mode</a></span><span class='op'>(</span><span class='st'>"regression"</span><span class='op'>)</span> 

<span class='va'>rule_fit_fit</span> <span class='op'>&lt;-</span> 
  <span class='va'>rule_fit_spec</span> <span class='op'><a href='https://magrittr.tidyverse.org/reference/pipe.html'>%&gt;%</a></span> 
  <span class='fu'><a href='https://generics.r-lib.org/reference/fit.html'>fit</a></span><span class='op'>(</span><span class='va'>body_mass_g</span> <span class='op'>~</span> <span class='va'>.</span>, data <span class='op'>=</span> <span class='va'>penguins</span><span class='op'>)</span>
</code></pre><p></div><div class="r"></p><pre class='sourceCode r'><code><span class='va'>rule_fit_fit</span>
<span class='co'>#&gt; parsnip model object</span>
<span class='co'>#&gt; </span>
<span class='co'>#&gt; Fit time:  2.1s </span>
<span class='co'>#&gt; An eXtreme RuleFit model of 112 rules.</span>
<span class='co'>#&gt; </span>
<span class='co'>#&gt; Original Formula:</span>
<span class='co'>#&gt; </span>
<span class='co'>#&gt; body_mass_g ~ species + island + bill_length_mm + bill_depth_mm + flipper_length_mm + [truncated]</span>
</code></pre><p></div></p>
<p>To get the rules and their associated coefficients, the <code><a href='https://generics.r-lib.org/reference/tidy.html'>tidy()</a></code> method
can be used again:<div class="r"></p><pre class='sourceCode r'><code><span class='va'>rf_res</span> <span class='op'>&lt;-</span> <span class='fu'><a href='https://generics.r-lib.org/reference/tidy.html'>tidy</a></span><span class='op'>(</span><span class='va'>rule_fit_fit</span><span class='op'>)</span>
<span class='va'>rf_res</span>
<span class='co'>#&gt; # A tibble: 110 × 3</span>
<span class='co'>#&gt;    rule_id           rule                                               estimate</span>
<span class='co'>#&gt;    &lt;chr&gt;             &lt;chr&gt;                                                 &lt;dbl&gt;</span>
<span class='co'>#&gt;  1 (Intercept)       ( TRUE )                                            5753.  </span>
<span class='co'>#&gt;  2 bill_depth_mm     ( bill_depth_mm )                                    -15.9 </span>
<span class='co'>#&gt;  3 bill_length_mm    ( bill_length_mm )                                     1.10</span>
<span class='co'>#&gt;  4 flipper_length_mm ( flipper_length_mm )                                 -7.67</span>
<span class='co'>#&gt;  5 islandDream       ( island == 'Dream' )                                -29.2 </span>
<span class='co'>#&gt;  6 islandTorgersen   ( island == 'Torgersen' )                            -16.8 </span>
<span class='co'>#&gt;  7 r0_2              ( species == 'Gentoo' )                              472.  </span>
<span class='co'>#&gt;  8 r0_3              ( sex != 'male' ) &amp; ( species != 'Gentoo' )          -78.8 </span>
<span class='co'>#&gt;  9 r1_2              ( flipper_length_mm &gt;= 211.5 )                       219.  </span>
<span class='co'>#&gt; 10 r1_3              ( flipper_length_mm &lt;  194.5 ) &amp; ( flipper_length…  -142.  </span>
<span class='co'>#&gt; # … with 100 more rows</span>
</code></pre><p></div></p>
<p>Note that the units of each predictor have been scaled to be between
zero and one.</p>
<p>Looking at the rules, there are examples of some rules, such as:<div class="r"></p><pre><code>( bill_depth_mm &gt;= 14.1499996 ) &amp; 
( flipper_length_mm &lt;  227 ) &amp; 
( flipper_length_mm &lt;  228.5 ) &amp; 
( flipper_length_mm &gt;= 197.5 ) &amp; 
( flipper_length_mm &gt;= 224.5 )"
</code></pre><p></div></p>
<p>which can be simplified to have fewer conditions:<div class="r"></p><pre><code>( bill_depth_mm &gt;= 14.1499996 ) &amp; 
( flipper_length_mm &lt;  227 ) &amp; 
( flipper_length_mm &gt;= 197.5 ) &amp; 
</code></pre><p></div></p>
<p>Also, the <code><a href='https://generics.r-lib.org/reference/tidy.html'>tidy()</a></code> function can extract the same information but use the
original predictors as the unit:<div class="r"></p><pre class='sourceCode r'><code><span class='va'>rf_variable_res</span> <span class='op'>&lt;-</span> <span class='fu'><a href='https://generics.r-lib.org/reference/tidy.html'>tidy</a></span><span class='op'>(</span><span class='va'>rule_fit_fit</span>, unit <span class='op'>=</span> <span class='st'>"columns"</span><span class='op'>)</span>
<span class='va'>rf_variable_res</span>
<span class='co'>#&gt; # A tibble: 452 × 3</span>
<span class='co'>#&gt;    rule_id term              estimate</span>
<span class='co'>#&gt;    &lt;chr&gt;   &lt;chr&gt;                &lt;dbl&gt;</span>
<span class='co'>#&gt;  1 r0_3    species             -78.8 </span>
<span class='co'>#&gt;  2 r0_2    species             472.  </span>
<span class='co'>#&gt;  3 r0_3    sex                 -78.8 </span>
<span class='co'>#&gt;  4 r1_3    flipper_length_mm  -142.  </span>
<span class='co'>#&gt;  5 r1_2    flipper_length_mm   219.  </span>
<span class='co'>#&gt;  6 r1_3    flipper_length_mm  -142.  </span>
<span class='co'>#&gt;  7 r2_7    flipper_length_mm     9.04</span>
<span class='co'>#&gt;  8 r2_7    sex                   9.04</span>
<span class='co'>#&gt;  9 r2_7    species               9.04</span>
<span class='co'>#&gt; 10 r3_3    flipper_length_mm  -101.  </span>
<span class='co'>#&gt; # … with 442 more rows</span>
</code></pre><p></div></p>
<p>A single rule might be represented with multiple rows of this version of
the data. These results can also be used to compute a rough estimate or
variable importance using the absolute value of the coefficients:<div class="r"></p><pre class='sourceCode r'><code><span class='va'>num_rules</span> <span class='op'>&lt;-</span> <span class='fu'><a href='https://rdrr.io/r/base/sum.html'>sum</a></span><span class='op'>(</span><span class='fu'><a href='https://rdrr.io/r/base/grep.html'>grepl</a></span><span class='op'>(</span><span class='st'>"^r[0-9]*_"</span>, <span class='fu'><a href='https://rdrr.io/r/base/unique.html'>unique</a></span><span class='op'>(</span><span class='va'>rf_res</span><span class='op'>$</span><span class='va'>rule_id</span><span class='op'>)</span><span class='op'>)</span><span class='op'>)</span> <span class='op'>+</span> <span class='fl'>1</span>

<span class='va'>rf_variable_res</span> <span class='op'><a href='https://magrittr.tidyverse.org/reference/pipe.html'>%&gt;%</a></span> 
  <span class='fu'>dplyr</span><span class='fu'>::</span><span class='fu'><a href='https://dplyr.tidyverse.org/reference/filter.html'>filter</a></span><span class='op'>(</span><span class='va'>term</span> <span class='op'>!=</span> <span class='st'>"(Intercept)"</span><span class='op'>)</span> <span class='op'><a href='https://magrittr.tidyverse.org/reference/pipe.html'>%&gt;%</a></span> 
  <span class='fu'><a href='https://dplyr.tidyverse.org/reference/group_by.html'>group_by</a></span><span class='op'>(</span><span class='va'>term</span><span class='op'>)</span> <span class='op'><a href='https://magrittr.tidyverse.org/reference/pipe.html'>%&gt;%</a></span> 
  <span class='fu'><a href='https://dplyr.tidyverse.org/reference/summarise.html'>summarize</a></span><span class='op'>(</span>effect <span class='op'>=</span> <span class='fu'><a href='https://rdrr.io/r/base/sum.html'>sum</a></span><span class='op'>(</span><span class='fu'><a href='https://rdrr.io/r/base/MathFun.html'>abs</a></span><span class='op'>(</span><span class='va'>estimate</span><span class='op'>)</span><span class='op'>)</span>, .groups <span class='op'>=</span> <span class='st'>"drop"</span><span class='op'>)</span> <span class='op'><a href='https://magrittr.tidyverse.org/reference/pipe.html'>%&gt;%</a></span> 
  <span class='fu'><a href='https://dplyr.tidyverse.org/reference/group_by.html'>ungroup</a></span><span class='op'>(</span><span class='op'>)</span> <span class='op'><a href='https://magrittr.tidyverse.org/reference/pipe.html'>%&gt;%</a></span> 
  <span class='co'># normalize by number of possible occurrences</span>
  <span class='fu'><a href='https://dplyr.tidyverse.org/reference/mutate.html'>mutate</a></span><span class='op'>(</span>effect <span class='op'>=</span> <span class='va'>effect</span> <span class='op'>/</span> <span class='va'>num_rules</span> <span class='op'>)</span> <span class='op'><a href='https://magrittr.tidyverse.org/reference/pipe.html'>%&gt;%</a></span> 
  <span class='fu'><a href='https://dplyr.tidyverse.org/reference/arrange.html'>arrange</a></span><span class='op'>(</span><span class='fu'><a href='https://dplyr.tidyverse.org/reference/desc.html'>desc</a></span><span class='op'>(</span><span class='va'>effect</span><span class='op'>)</span><span class='op'>)</span>
<span class='co'>#&gt; # A tibble: 6 × 2</span>
<span class='co'>#&gt;   term              effect</span>
<span class='co'>#&gt;   &lt;chr&gt;              &lt;dbl&gt;</span>
<span class='co'>#&gt; 1 flipper_length_mm 219.  </span>
<span class='co'>#&gt; 2 bill_depth_mm     175.  </span>
<span class='co'>#&gt; 3 bill_length_mm    175.  </span>
<span class='co'>#&gt; 4 species            69.5 </span>
<span class='co'>#&gt; 5 sex                52.0 </span>
<span class='co'>#&gt; 6 island              9.84</span>
</code></pre><p></div></p>

<h3 class='hasAnchor' id='references'><a class='anchor' aria-hidden='true' href='#references'></a>References</h3>

<ul>
<li><p>Quinlan R (1987). “Simplifying Decision Trees.” <em>International
Journal of Man-Machine Studies</em>, 27(3), 221-234.</p></li>
<li><p>Quinlan R (1992). “Learning with Continuous Classes.” <em>Proceedings
of the 5th Australian Joint Conference On Artificial Intelligence</em>,
pp. 343-348.</p></li>
<li><p>Quinlan R (1993). “Combining Instance-Based and Model-Based
Learning.” <em>Proceedings of the Tenth International Conference on
Machine Learning</em>, pp. 236-243.</p></li>
</ul>



  </div>
  <div class="col-md-3 hidden-xs hidden-sm" id="pkgdown-sidebar">
    <nav id="toc" data-toggle="toc" class="sticky-top">
      <h2 data-toc-skip>Contents</h2>
    </nav>
  </div>
</div>


      <footer>
      <div class="tidyverse">
  <p>rules is a part of the <strong>tidymodels</strong> ecosystem, a collection of modeling packages designed with common APIs and a shared philosophy.</p>
</div>

<div class="author">
  <p>
    Developed by Max Kuhn.
    Site built by <a href="https://pkgdown.r-lib.org">pkgdown</a>.
  </p>
</div>

      </footer>
   </div>

  


  

  </body>
</html>


